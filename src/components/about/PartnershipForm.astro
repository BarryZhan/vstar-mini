---
/**
 * 联盟合作计划区块组件
 *
 * @description 包含联盟合作表单和办公地址信息
 */

const offices = [
  {
    country: 'Australia',
    address:
      'UNIT 1, 5-7 Compark Circuit, Mulgrave VIC 3170, Melbourne, Australia',
  },
  {
    country: 'Mauritius',
    address:
      'Suite 602, 6th Floor, Hennessy Tower, Pope Hennessy Street, Port Louis, Mauritius',
  },
]
---

<!-- 联盟合作计划区块 -->
<section class="bg-white py-16 md:py-20 lg:py-28">
  <div class="content-container">
    <!-- 标题 -->
    <h2
      class="text-heading-1  text-center font-bold text-dark heading-margin"
    >
      联盟合作计划
    </h2>

    <div class="grid grid-cols-1 gap-8 lg:grid-cols-2 lg:gap-16 ">
      <!-- 左侧：办公地址 -->
      <div class="space-y-5 md:space-y-6 lg:pt-15">
        {
          offices.map((office) => (
            <div class="p-4 lg:p-7">
              <div class="mb-4 flex items-center lg:justify-start justify-center gap-1">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M12 22C12 22 19.5 16 19.5 9.5C19.5 5.35785 16.1421 2 12 2C7.85785 2 4.5 5.35785 4.5 9.5C4.5 16 12 22 12 22Z"
                    fill="black"
                    fill-opacity="0.2"
                  />
                  <path
                    d="M12 12.5C13.6568 12.5 15 11.1568 15 9.5C15 7.84315 13.6568 6.5 12 6.5C10.3432 6.5 9 7.84315 9 9.5C9 11.1568 10.3432 12.5 12 12.5Z"
                    fill="white"
                    stroke="white"
                    stroke-width="2"
                    stroke-linejoin="round"
                  />
                </svg>

                <h3 class="text-body-lg font-bold text-dark">
                  {office.country}
                </h3>
              </div>
              <p class="text-body-sm text-center lg:text-left text-dark/60">
                {office.address}
              </p>
            </div>
          ))
        }
      </div>

      <!-- 右侧：联系表单 -->
      <div
        class=""
      >
        <h3
          class="mb-6 heading-margin font-bold text-dark text-heading-2 text-center lg:text-left"
        >
          联系我们
        </h3>

        <!-- 提示消息区域 -->
        <div id="form-message" class="mb-4 hidden rounded-lg p-4" role="alert">
        </div>

        <form id="partnership-form" class="space-y-6">
          <!-- 姓名 -->
          <div>
            <label
              for="username"
              class="mb-2 block  text-body-md font-medium text-dark"
            >
              姓名*
            </label>
            <input
              type="text"
              id="username"
              name="username"
              required
              minlength="1"
              maxlength="32"
              class="w-full rounded-lg border border-[#E5E9EF]  bg-[#F3F3F3] px-4 py-3 text-[16px] transition-colors focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
              placeholder="请输入您的姓名（1-32字符）"
            />
            <p class="mt-1 hidden text-sm text-red-600" id="username-error"></p>
          </div>

          <!-- 邮箱和手机号 -->
          <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
            <!-- 邮箱 -->
            <div>
              <label
                for="email"
                class="mb-2 block  text-body-md font-medium text-dark"
              >
                邮箱
              </label>
              <input
                type="email"
                id="email"
                name="email"
                maxlength="64"
                class="w-full rounded-lg border bg-[#F3F3F3] border-[#E5E9EF] px-4 py-3 text-[16px] transition-colors focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
                placeholder="your@email.com（选填）"
              />
              <p class="mt-1 hidden text-sm text-red-600" id="email-error"></p>
            </div>

            <!-- 手机号码 -->
            <div>
              <label
                for="phone"
                class="mb-2 block  text-body-md font-medium text-dark"
              >
                手机号码*
              </label>
              <input
                type="tel"
                id="phone"
                name="phone"
                required
                maxlength="11"
                class="w-full rounded-lg border border-[#E5E9EF]  bg-[#F3F3F3] px-4 py-3 text-[16px] transition-colors focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
                placeholder="请输入手机号码"
              />
              <p class="mt-1 hidden text-sm text-red-600" id="phone-error"></p>
            </div>
          </div>

          <!-- 留言 -->
          <div>
            <label
              for="content"
              class="mb-2 block  text-body-md font-medium text-dark"
            >
              留言* <span class="text-sm text-gray-500">(10-2000字符)</span>
            </label>
            <textarea
              id="content"
              name="content"
              required
              minlength="10"
              maxlength="2000"
              rows="5"
              class="w-full rounded-lg border border-[#E5E9EF]  bg-[#F3F3F3] px-4 py-3 text-[16px] transition-colors focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
              placeholder="请输入您的留言内容（10-2000字符）"></textarea>
            <p class="mt-1 text-sm text-gray-500">
              <span id="content-count">0</span> / 2000
            </p>
            <p class="mt-1 hidden text-sm text-red-600" id="content-error"></p>
          </div>

          <!-- 提交按钮 -->
          <button
            type="submit"
            id="submit-btn"
            class="w-full rounded-lg bg-primary px-8 py-4 text-[16px] font-medium text-white transition-colors hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary/50 disabled:cursor-not-allowed disabled:opacity-50 md:text-[18px]"
          >
            <span id="submit-text">提交</span>
            <span id="submit-loading" class="hidden">提交中...</span>
          </button>
        </form>
      </div>
    </div>
  </div>
</section>

<script>
  import md5 from 'blueimp-md5'

  // 生成 UUID
  function generateUUID(): string {
    let d = new Date().getTime()
    if (
      typeof performance !== 'undefined' &&
      typeof performance.now === 'function'
    ) {
      d += performance.now()
    }
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
      const r = (d + Math.random() * 16) % 16 | 0
      d = Math.floor(d / 16)
      return (c === 'x' ? r : (r & 0x3) | 0x8).toString(16)
    })
  }

  // DeviceId 管理
  let DeviceId = localStorage.getItem('DeviceId') || generateUUID()
  localStorage.setItem('DeviceId', DeviceId)

  // 接口请求类型定义
  interface SuggestRequest {
    username: string
    email: string
    phone: string
    content: string
    type: number
  }

  interface ApiResponse {
    status: number
    code?: number
    message: string
    data?: any
  }

  // 表单元素
  const form = document.getElementById('partnership-form') as HTMLFormElement
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement
  const submitText = document.getElementById('submit-text') as HTMLSpanElement
  const submitLoading = document.getElementById(
    'submit-loading',
  ) as HTMLSpanElement
  const messageBox = document.getElementById('form-message') as HTMLDivElement

  // 表单字段
  const usernameInput = document.getElementById('username') as HTMLInputElement
  const emailInput = document.getElementById('email') as HTMLInputElement
  const phoneInput = document.getElementById('phone') as HTMLInputElement
  const contentInput = document.getElementById('content') as HTMLTextAreaElement

  // 错误提示元素
  const usernameError = document.getElementById(
    'username-error',
  ) as HTMLParagraphElement
  const emailError = document.getElementById(
    'email-error',
  ) as HTMLParagraphElement
  const phoneError = document.getElementById(
    'phone-error',
  ) as HTMLParagraphElement
  const contentError = document.getElementById(
    'content-error',
  ) as HTMLParagraphElement

  // 字符计数
  const contentCount = document.getElementById(
    'content-count',
  ) as HTMLSpanElement

  // 更新留言字符计数
  contentInput?.addEventListener('input', () => {
    if (contentCount) {
      contentCount.textContent = contentInput.value.length.toString()
    }
  })

  // 显示错误消息
  function showError(element: HTMLParagraphElement, message: string) {
    element.textContent = message
    element.classList.remove('hidden')
  }

  // 隐藏错误消息
  function hideError(element: HTMLParagraphElement) {
    element.textContent = ''
    element.classList.add('hidden')
  }

  // 显示表单消息
  function showMessage(message: string, type: 'success' | 'error') {
    messageBox.textContent = message
    messageBox.classList.remove(
      'hidden',
      'bg-green-100',
      'text-green-800',
      'bg-red-100',
      'text-red-800',
    )

    if (type === 'success') {
      messageBox.classList.add('bg-green-100', 'text-green-800')
    } else {
      messageBox.classList.add('bg-red-100', 'text-red-800')
    }

    // 3秒后自动隐藏
    setTimeout(() => {
      messageBox.classList.add('hidden')
    }, 5000)
  }

  // 表单验证
  function validateForm(): boolean {
    let isValid = true

    // 清除所有错误
    hideError(usernameError)
    hideError(emailError)
    hideError(phoneError)
    hideError(contentError)

    // 验证姓名
    const username = usernameInput.value.trim()
    if (!username) {
      showError(usernameError, '请输入姓名')
      isValid = false
    } else if (username.length < 1 || username.length > 32) {
      showError(usernameError, '姓名长度应为1-32字符')
      isValid = false
    }

    // 验证邮箱（可选，但如果填写需要验证格式）
    const email = emailInput.value.trim()
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
    if (email) {
      if (email.length > 64) {
        showError(emailError, '邮箱长度不能超过64字符')
        isValid = false
      } else if (!emailRegex.test(email)) {
        showError(emailError, '请输入有效的邮箱地址')
        isValid = false
      }
    }

    // 验证手机号（必填，格式为1开头的11位数字）
    const phone = phoneInput.value.trim()
    const phoneRegex = /^1\d{10}$/
    if (!phone) {
      showError(phoneError, '请输入手机号码')
      isValid = false
    } else if (!phoneRegex.test(phone)) {
      showError(phoneError, '请输入正确的手机号码')
      isValid = false
    }

    // 验证留言
    const content = contentInput.value.trim()
    if (!content) {
      showError(contentError, '请输入留言内容')
      isValid = false
    } else if (content.length < 10) {
      showError(contentError, '留言内容至少需要10个字符')
      isValid = false
    } else if (content.length > 2000) {
      showError(contentError, '留言内容不能超过2000个字符')
      isValid = false
    }

    return isValid
  }

  // HTTP 请求函数 (参考注册代码的加密方式)
  async function http(params: {
    url: string
    method?: string
    data?: any
    success?: (data: ApiResponse) => void
    error?: (data?: any) => void
  }) {
    const Timestamp = String(Date.now())
    const RequestId = generateUUID()
    const signKey = '3$%87vB^' // 签名密钥，与注册代码保持一致

    try {
      const response = await fetch('https://apigf.qiwang2025.com' + params.url, {
        method: params.method || 'POST',
        headers: {
          DeviceId: DeviceId,
          RequestId: RequestId,
          Timestamp: Timestamp,
          Platform: 'pc',
          Version: '1.0.0',
          Sign: md5(DeviceId + RequestId + Timestamp + signKey),
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(params.data),
      })

      const data: ApiResponse = await response.json()
      console.log(data)

      if (data.status !== 100) {
        showMessage(data.message, 'error')
        if (params.error) {
          params.error()
        }
        return
      }

      if (params.success) {
        params.success(data)
      }
    } catch (error) {
      console.log(error)
      if (params.error) {
        params.error(error)
      }
    }
  }

  // 提交表单
  async function submitForm(data: SuggestRequest) {
    http({
      url: '/v1/public/pc/suggest/submit',
      data: data,
      success: function (result) {
        showMessage('提交成功！我们会尽快与您联系。', 'success')
        form.reset()
        if (contentCount) {
          contentCount.textContent = '0'
        }
      },
      error: function () {
        // 错误消息已在 http 函数中显示
      },
    })
  }

  // 表单提交处理
  form?.addEventListener('submit', async (e) => {
    e.preventDefault()

    // 验证表单
    if (!validateForm()) {
      return
    }

    // 禁用提交按钮
    submitBtn.disabled = true
    submitText.classList.add('hidden')
    submitLoading.classList.remove('hidden')

    // 准备数据
    const formData: SuggestRequest = {
      username: usernameInput.value.trim(),
      email: emailInput.value.trim(),
      phone: phoneInput.value.trim(),
      content: contentInput.value.trim(),
      type: 1,
    }

    try {
      await submitForm(formData)
    } finally {
      // 恢复提交按钮
      submitBtn.disabled = false
      submitText.classList.remove('hidden')
      submitLoading.classList.add('hidden')
    }
  })
</script>
